AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: MyOwnNews MVP â€” RSS -> LLM script -> Polly MP3 -> S3

Parameters:
  ModelId:
    Type: String
    Default: anthropic.claude-3-haiku-20240307-v1:0
    Description: Claude 3 Haiku - Now available in us-west-2!
  NewsApiKey:
    Type: String
    Default: "56e5f744fdb04e1e8e45a450851e442d"
    Description: News API key for fetching headlines
    NoEcho: true
  NewsCategories:
    Type: String
    Default: "general,technology,business,science"
    Description: Comma-separated News API categories (general, business, entertainment, health, science, sports, technology)
  VoiceId:
    Type: String
    Default: Joanna
    Description: Voice ID - Polly Neural (Joanna, Matthew, Amy, Emma) or ElevenLabs voice ID
  VoiceProvider:
    Type: String
    Default: polly
    Description: Voice provider - 'polly' for Amazon Polly or 'elevenlabs' for ElevenLabs
  ElevenLabsApiKey:
    Type: String
    Default: ""
    Description: ElevenLabs API key (optional, leave empty to use Polly)
    NoEcho: true
  MaxArticles:
    Type: Number
    Default: 3
    Description: How many items to summarize per run

Globals:
  Function:
    Runtime: python3.11
    Timeout: 180
    MemorySize: 1024
    Tracing: Active

Resources:
  AssetsBucket:
    Type: AWS::S3::Bucket
    Properties:
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  NewsToAudioFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: myownnews/
      Handler: app.lambda_handler
      Environment:
        Variables:
          BUCKET: !Ref AssetsBucket
          MODEL_ID: !Ref ModelId
          NEWS_API_KEY: !Ref NewsApiKey
          NEWS_CATEGORIES: !Ref NewsCategories
          VOICE_ID: !Ref VoiceId
          VOICE_PROVIDER: !Ref VoiceProvider
          ELEVENLABS_API_KEY: !Ref ElevenLabsApiKey
          MAX_ARTICLES: !Ref MaxArticles
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref AssetsBucket
        - Statement:
            - Sid: AllowBedrockInvoke
              Effect: Allow
              Action:
                - bedrock:InvokeModel
                - bedrock:InvokeModelWithResponseStream
              Resource: "*"
            - Sid: AllowPolly
              Effect: Allow
              Action:
                - polly:SynthesizeSpeech
              Resource: "*"
      Events:
        # Optional schedule, enable later after testing
        # DailySchedule:
        #   Type: Schedule
        #   Properties:
        #     Schedule: cron(0 13 * * ? *)
        #     Name: MyOwnNewsDaily
        #     Enabled: false

Outputs:
  BucketName:
    Value: !Ref AssetsBucket
  FunctionName:
    Value: !Ref NewsToAudioFunction
